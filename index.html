<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ±åŒ—å¤§é·å¾™ - æ™ºæ…§å°éŠ</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    window.firebaseModules = { initializeApp, getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, getStorage, ref, uploadBytes, getDownloadURL };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Inter:wght@400;600&display=swap');
    
    body { background-color: #FDFAF5; font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .font-serif { font-family: 'Noto Serif TC', serif; }
    .font-sans-eng { font-family: 'Inter', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* å‹•ç•«æ•ˆæœ */
    .fade-in { animation: fadeIn 0.4s ease-out forwards; will-change: transform, opacity; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .scale-in { animation: scaleIn 0.2s ease-out forwards; }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ç‰ˆæœ¬æ§åˆ¶
    const DATA_VERSION = "v18.0_TowadaTicketsAdded";

    const firebaseConfig = {
      apiKey: "AIzaSyC2IjvPIILHl3ftIZ8Iw2pBDWoXbE8SKAw",
      authDomain: "tohoku-travel-app.firebaseapp.com",
      projectId: "tohoku-travel-app",
      storageBucket: "tohoku-travel-app.appspot.com",
      messagingSenderId: "674159226780",
      appId: "1:674159226780:web:92dda0de23fb328114e259",
      measurementId: "G-8P7HE76T86"
    };

    // --- 1. é è¨­è¡Œç¨‹è³‡æ–™ ---
    const INITIAL_DATA = {
      version: DATA_VERSION,
      schedule: [
        { date: "01/31 (å…­)", weather: { city: "æ±äº¬", temp: "-", icon: "cloud-sun" }, items: [ { id: "s0", type: "transport", time: "06:55", title: "èµ·é£›ï¼šé«˜é›„ -> æˆç”°", location: "å°æ¸¯æ©Ÿå ´", desc: "BR/JL èˆªç­", tags: ["é›†åˆ"] }, { id: "s01", type: "stay", time: "19:00", title: "APA Hotel Ueno", location: "APA Hotel Ueno Ekimae", desc: "å…¨å“¡æ±äº¬é›†åˆ", tags: ["ä½å®¿"] } ] },
        { date: "02/01 (æ—¥)", weather: { city: "æ±äº¬", temp: "-", icon: "sun" }, items: [ { id: "s1", type: "food", time: "12:00", title: "ç‡’è‚‰ 29 Terrace", location: "Yakiniku 29 Terrace", desc: "å¿…åƒé«˜è©•åƒ¹ç‡’è‚‰", tags: ["å·²è¨‚ä½"], guide: { mustEat: ["åšåˆ‡ç‰›èˆŒ"], reservation: { code: "æ›¸ç‘œ" } } }, { id: "s1b", type: "spot", time: "20:30", title: "Memento Mori", location: "Toranomon Hills", desc: "ä¸–ç•Œå¯å¯è±†éˆæ„Ÿé…’å§", tags: ["Cacaoèª¿é…’"], guide: { story: "ğŸ« æ¦‚å¿µï¼šä»¥ä¸–ç•Œå„åœ°çš„å¯å¯è±†ç‚ºéˆæ„Ÿè¨­è¨ˆ|ğŸ§ª ç‰¹è‰²ï¼šé€™è£¡ä¸è«‡ç”Ÿæ­»ï¼Œè€Œæ˜¯åƒå¯¦é©—å®¤ä¸€æ¨£èƒå–å¯å¯çš„é¢¨å‘³|ğŸ¸ å¿…é»ï¼šCacao Pulp Fizz (å¯å¯æœè‚‰èª¿é…’)|ğŸ“ ä½ç½®ï¼šè™ä¹‹é–€ Hills 3æ¨“ï¼Œé»‘è‰²å¯†é–€" } } ] },
        { date: "02/02 (ä¸€)", weather: { city: "éŠ€å±±", temp: "-", icon: "snowflake" }, items: [ { id: "t1", type: "transport", time: "07:18", title: "æ–°å¹¹ç·š -> å¤§çŸ³ç”°", location: "Ueno Station", desc: "å±±å½¢æ–°å¹¹ç·š", tags: ["JR Pass"] }, { id: "s3", type: "stay", time: "15:00", title: "éŠ€å±±æº«æ³‰ å¤å±±é–£", location: "Ginzan Onsen", desc: "å°¾æ¬¾ä»˜ç¾", cashAlert: 123800 } ] },
        { date: "02/03 (äºŒ)", weather: { city: "ç§‹ç”°", temp: "-", icon: "snowflake" }, items: [ { id: "t3_1", type: "transport", time: "09:40", title: "å¤å±±é–£æ¥é§è»Š", location: "Ginzan Onsen", desc: "å‰å¾€ JR å¤§çŸ³ç”°ç«™", tags: ["å…è²»æ¥é§"] }, { id: "t3_2", type: "transport", time: "10:31", title: "å±±å½¢æ–°å¹¹ç·š -> æ–°åº„", location: "Oishida Station", desc: "ã¤ã°ã• (å°è™Ÿåº§)", tags: ["JR Pass"] }, { id: "t3_3", type: "transport", time: "11:18", title: "å¥§ç¾½æœ¬ç·š -> é™¢å…§", location: "Shinjo Station", desc: "å¾€ æ©«å € è¡Œ", tags: ["æ™®é€šè»Š"] }, { id: "t3_4", type: "transport", time: "12:11", title: "å¥§ç¾½æœ¬ç·š -> å¤§æ›²", location: "Innai Station", desc: "å¾€ ç§‹ç”° è¡Œ", tags: ["æ™®é€šè»Š"] }, { id: "t3_5", type: "transport", time: "13:39", title: "ç§‹ç”°æ–°å¹¹ç·š -> è§’é¤¨", location: "Omagari Station", desc: "ã“ã¾ã¡ (å°è™Ÿåº§)", tags: ["JR Pass"] }, { id: "f_kakunodate", type: "food", time: "14:00", title: "ãŠé£Ÿäº‹å‡¦ æ¡œã®é‡Œ", location: "Kakunodate", desc: "å¿…åƒï¼šæ¯”å…§åœ°é›è¦ªå­ä¸¼ & ç¨»åº­çƒé¾éºµ", tags: ["åˆé¤"] }, { id: "t3_6", type: "transport", time: "17:02", title: "å‰å¾€ç”°æ¾¤æ¹–ç«™", location: "Kakunodate Station", desc: "è»Šç¨‹ç´„ 13 åˆ†é˜", tags: [] }, { id: "t3_7", type: "transport", time: "17:20", title: "ç”°æ¾¤æ¹–ä¸€å‘¨ç·š (å³å‘¨ã‚Š)", location: "Tazawako Station", desc: "å‰å¾€ã€Œä¸Šç”°å­ãƒæœ¨ã€", tags: ["å·´å£«"], guide: { story: "ğŸšŒ ç«™ç‰Œï¼šç”°æ¾¤æ¹–ç«™å‰|ğŸš ä¸‹è»Šï¼šä¸Šç”°å­ãƒæœ¨ (17:39 æŠµé”)|ğŸš¶ æ­¥è¡Œï¼šä¸‹è»Šå¾Œæ­¥è¡Œç´„ 3 åˆ†é˜æŠµé”æ°‘å®¿" } }, { id: "s4", type: "stay", time: "18:00", title: "ç”°æ¾¤æ¹–æ°‘å®¿ Farmstay", location: "Tazawako", desc: "é«”é©—é“åœ°ç§‹ç”°è¾²å®¶ç”Ÿæ´»", tags: ["ä¸€æ³ŠäºŒé£Ÿ"] } ] },
        { date: "02/04 (ä¸‰)", weather: { city: "ä¹³é ­", temp: "-", icon: "snowflake" }, items: [ { id: "s6", type: "stay", time: "15:00", title: "ä¹³é ­æº«æ³‰ é¶´ä¹‹æ¹¯", location: "Tsurunoyu Onsen", desc: "ç§˜æ¹¯æ··æµ´", cashAlert: 69520 } ] },
        { date: "02/05 (å››)", weather: { city: "å¥§å…¥ç€¨", temp: "-", icon: "snowflake" }, items: [ { id: "s7", type: "stay", time: "15:00", title: "æ˜Ÿé‡å¥§å…¥ç€¨", location: "Hoshino Resorts", desc: "é ˜å–è¡Œæ", tags: ["å¿…ä½"] } ] }
      ],
      tools: { 
        // å…§å»ºç¥¨åˆ¸
        tickets: [
          { 
            name: "ğŸšŒ åå’Œç”°æ¹–æ¥é§ (å»ç¨‹)", type: "virtual", date: "2026/02/06",
            details: { id: "TOW-T119238569", time: "15:55", from: "å¥§å…¥ç€¨æºªæµé¤¨å…¬å»å‰", to: "ä¼‘å±‹åŒ—åœè»Šå ´å»æ‰€å‰", pax: "4 Adult" }
          },
          { 
            name: "ğŸšŒ åå’Œç”°æ¹–æ¥é§ (å›ç¨‹)", type: "virtual", date: "2026/02/06",
            details: { id: "TOW-T119238576", time: "20:20", from: "ä¼‘å±‹åŒ—åœè»Šå ´å»æ‰€å‰", to: "å¥§å…¥ç€¨æºªæµé¤¨", pax: "4 Adult" }
          }
        ], 
        flights: [], reservations: [], stays: [] 
      }
    };

    // --- 2. å¯¦ç”¨æ—¥èª ---
    const JAPANESE_PHRASES = [
      { category: "é¤å»³ & é ç´„", icon: "calendar-check", phrases: [ { jp: "äºˆç´„ã—ã¦ã„ã¾ã™ã€‚", romaji: "Yoyaku shiteimasu", zh: "æˆ‘æœ‰é ç´„", note: "é€²åº—ç¬¬ä¸€å¥è©±" }, { jp: "4äººã§ã™ã€‚", romaji: "Yo-nin desu", zh: "æˆ‘å€‘æœ‰ 4 å€‹äºº", note: "" }, { jp: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚", romaji: "O-kaikei o onegaishimasu", zh: "éº»ç…©çµå¸³", note: "" } ] },
      { category: "è¬èƒ½å¥å‹", icon: "sparkles", phrases: [ { jp: "______ ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", romaji: "... wa arimasu ka?", zh: "è«‹å•æœ‰ ______ å—ï¼Ÿ", note: "ğŸ‘‰ å¡«ç©ºï¼šå»æ‰€(Toire)ã€èœå–®(Menu)" }, { jp: "______ ã‚’ãã ã•ã„ã€‚", romaji: "... o kudasai", zh: "è«‹çµ¦æˆ‘ ______", note: "ğŸ‘‰ å¡«ç©ºï¼šé€™å€‹(Kore)ã€æ°´(Omizu)" }, { jp: "______ ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", romaji: "... wa doko desu ka?", zh: "è«‹å• ______ åœ¨å“ªè£¡ï¼Ÿ", note: "ğŸ‘‰ å¡«ç©ºï¼šè»Šç«™(Eki)ã€é€™è£¡(Koko)" } ] },
      { category: "è³¼ç‰©", icon: "shopping-bag", phrases: [ { jp: "è¢‹ã‚’ãã ã•ã„ã€‚", romaji: "Fukuro o kudasai", zh: "è«‹çµ¦æˆ‘å¡‘è† è¢‹", note: "" }, { jp: "ãƒ¬ã‚·ãƒ¼ãƒˆã¯è¦ã‚Šã¾ã›ã‚“ã€‚", romaji: "Reshiito wa irimasen", zh: "ä¸éœ€è¦æ”¶æ“š", note: "" }, { jp: "å…ç¨ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ", romaji: "Menzei ni narimasu ka?", zh: "å¯ä»¥å…ç¨…å—ï¼Ÿ", note: "" } ] },
      { category: "æ€¥æ•‘ SOS", icon: "ambulance", phrases: [ { jp: "å…·åˆãŒæ‚ªã„ã§ã™ã€‚", romaji: "Guai ga warui desu", zh: "æˆ‘ä¸èˆ’æœ", note: "" }, { jp: "è–¬ã‚’ãã ã•ã„ã€‚", romaji: "Kusuri o kudasai", zh: "è«‹çµ¦æˆ‘è—¥", note: "" } ] }
    ];

    const CITY_COORDS = { "æ±äº¬":{lat:35.6895,lon:139.6917}, "éŠ€å±±":{lat:38.5705,lon:140.3996}, "ç§‹ç”°":{lat:39.7167,lon:140.1032}, "ä¹³é ­":{lat:39.7995,lon:140.7692}, "å¥§å…¥ç€¨":{lat:40.5847,lon:140.9631} };
    const TYPE_STYLES = { transport:{color:"border-blue-400",text:"text-blue-500",bg:"bg-blue-50",label:"TRANSPORT",icon:"train-front"}, food:{color:"border-orange-400",text:"text-orange-500",bg:"bg-orange-50",label:"DINING",icon:"utensils"}, stay:{color:"border-indigo-400",text:"text-indigo-500",bg:"bg-indigo-50",label:"ACCOMMODATION",icon:"bed"}, spot:{color:"border-teal-500",text:"text-teal-600",bg:"bg-teal-50",label:"SIGHTSEEING",icon:"camera"}, default:{color:"border-gray-300",text:"text-gray-400",bg:"bg-gray-50",label:"ACTIVITY",icon:"circle"} };

    const LucideIcon = ({ name, className }) => {
      const ref = useRef(null);
      useEffect(() => { if (window.lucide && ref.current) { ref.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`; window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { class: className } }); } }, [name, className]);
      return <span ref={ref} style={{display:'inline-flex'}}></span>;
    };

    const App = () => {
      const [tripData, setTripData] = useState(null);
      const [activeTab, setActiveTab] = useState('schedule');
      const [isEditMode, setIsEditMode] = useState(false);
      const [activeTicket, setActiveTicket] = useState(null);
      const [openPhraseCategory, setOpenPhraseCategory] = useState(null);
      const [activePhrase, setActivePhrase] = useState(null);

      // --- è³‡æ–™è¼‰å…¥æ ¸å¿ƒ ---
      const BUILT_IN_TICKETS = INITIAL_DATA.tools.tickets;

      const loadAndMigrate = (data) => {
        if (!data.version || data.version !== DATA_VERSION) {
          console.log("åµæ¸¬åˆ°èˆŠç‰ˆæœ¬è³‡æ–™ï¼ŒåŸ·è¡Œå¼·åˆ¶å‡ç´š...");
          return INITIAL_DATA; 
        }
        // ç¢ºä¿ç¥¨åˆ¸ä¸æ¶ˆå¤±
        const newData = JSON.parse(JSON.stringify(data));
        if (!newData.tools) newData.tools = INITIAL_DATA.tools;
        if (!newData.tools.tickets) newData.tools.tickets = [];
        const existingNames = newData.tools.tickets.map(t => t.name);
        BUILT_IN_TICKETS.forEach(ticket => {
          if (!existingNames.includes(ticket.name)) {
            newData.tools.tickets.push(ticket);
          }
        });
        return newData;
      };

      useEffect(() => {
        const initData = async () => {
          const saved = localStorage.getItem('trip_backup');
          let currentData = saved ? JSON.parse(saved) : null;
          if (!currentData || currentData.version !== DATA_VERSION) {
            currentData = INITIAL_DATA;
            localStorage.setItem('trip_backup', JSON.stringify(INITIAL_DATA));
          }
          setTripData(currentData);
          if (window.firebaseModules) {
             const { initializeApp, getFirestore, doc, onSnapshot } = window.firebaseModules;
             const app = initializeApp(firebaseConfig);
             const db = getFirestore(app);
             onSnapshot(doc(db, "trips", "main"), (snap) => {
               if (snap.exists()) { setTripData(loadAndMigrate(snap.data())); }
             }, (err) => {});
          }
        };
        initData();
      }, []);

      const updateData = (newData) => {
        setTripData(newData);
        localStorage.setItem('trip_backup', JSON.stringify(newData));
        if (window.firebaseModules) { 
          try {
            const { getFirestore, doc, updateDoc } = window.firebaseModules;
            updateDoc(doc(getFirestore(), "trips", "main"), newData);
          } catch(e) {}
        }
      };

      const handleForceReset = () => {
        if(!confirm("âš ï¸ ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ç‹€æ…‹ï¼Ÿ")) return;
        localStorage.removeItem('trip_backup');
        window.location.reload();
      };

      const handleFileUpload = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        let url = "";
        if(file.type === "application/pdf") {
           url = await new Promise(r => { const fr = new FileReader(); fr.onload = e => r(e.target.result); fr.readAsDataURL(file); });
        } else {
           url = await new Promise(r => { 
             const fr = new FileReader(); fr.onload = ev => {
               const img = new Image(); img.onload = () => {
                 const cvs = document.createElement('canvas'); 
                 const scale = 800 / img.width; 
                 cvs.width = 800; cvs.height = img.height * scale;
                 cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                 r(cvs.toDataURL('image/jpeg', 0.7));
               }; img.src = ev.target.result;
             }; fr.readAsDataURL(file);
           });
        }
        const newData = JSON.parse(JSON.stringify(tripData));
        newData.tools.tickets.push({ name: file.name, url: url, type: file.type, date: new Date().toLocaleDateString() });
        updateData(newData);
        alert("âœ… ä¸Šå‚³æˆåŠŸ");
      };

      const handleDeleteTicket = (index) => { 
        if (!confirm("åˆªé™¤ï¼Ÿ")) return; 
        const newData = JSON.parse(JSON.stringify(tripData)); 
        newData.tools.tickets.splice(index, 1); 
        updateData(newData); 
        setActiveTicket(null); 
      };

      // ç·¨è¼¯åŠŸèƒ½
      const handleEditField = (path, val, label) => {
        const newVal = prompt(`ä¿®æ”¹ ${label}:`, val);
        if (newVal === null) return;
        const newData = JSON.parse(JSON.stringify(tripData));
        const parts = path.split('.');
        let current = newData;
        for (let i = 0; i < parts.length - 1; i++) current = current[parts[i]];
        current[parts[parts.length - 1]] = newVal;
        updateData(newData);
      };

      const handleDeleteItem = (dayIdx, itemIdx) => {
        if(!confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) return;
        const newData = JSON.parse(JSON.stringify(tripData));
        newData.schedule[dayIdx].items.splice(itemIdx, 1);
        updateData(newData);
      };

      const handleAddItem = (dayIdx) => {
        const newData = JSON.parse(JSON.stringify(tripData));
        newData.schedule[dayIdx].items.push({ id: Date.now().toString(), time: "00:00", title: "æ–°è¡Œç¨‹", location: "åœ°é»", desc: "å‚™è¨»", type: "spot" });
        updateData(newData);
      };

      if (!tripData) return <div className="flex h-screen items-center justify-center text-gray-500">è¼‰å…¥ä¸­...</div>;

      return (
        <div className="max-w-md mx-auto min-h-screen relative shadow-2xl bg-[#FDFAF5] pb-24">
          
          {/* --- åˆ†é ï¼šè¡Œç¨‹ (Schedule) --- */}
          {activeTab === 'schedule' && (
            <div className="pt-20 px-5 animate-fade-in">
              {tripData.schedule.map((day, idx) => (
                <div key={idx} className="mb-10">
                  <div className="flex items-center mb-4 sticky top-0 bg-[#FDFAF5]/95 backdrop-blur py-2 z-10">
                    <div className="w-2 h-8 bg-[#2C2C2C] mr-3"></div>
                    <h2 className="text-2xl font-serif font-bold text-[#2C2C2C]">{day.date}</h2>
                    <span className="ml-auto text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">{day.weather.city}</span>
                  </div>
                  <div className="space-y-6">
                    {day.items.map((item, i) => {
                      const style = TYPE_STYLES[item.type] || TYPE_STYLES.default;
                      return (
                        <div key={i} className="flex gap-4 relative group">
                          <div className="w-12 text-right pt-1">
                            <span className="font-serif text-lg font-bold text-gray-800">{item.time}</span>
                            {isEditMode && <button onClick={() => handleEditField(`schedule.${idx}.items.${i}.time`, item.time, 'æ™‚é–“')} className="block ml-auto text-yellow-500"><LucideIcon name="pencil" className="w-3 h-3"/></button>}
                          </div>
                          <div className={`flex-1 border-l-2 ${style.color} pl-5 pb-4`}>
                            <div className="mb-1 flex items-center justify-between">
                              <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${style.bg} ${style.text} tracking-wider mr-2`}>{style.label}</span>
                              {isEditMode && <button onClick={() => handleDeleteItem(idx, i)} className="text-red-400"><LucideIcon name="trash-2" className="w-3 h-3"/></button>}
                            </div>
                            <h3 className="text-lg font-bold text-[#2C2C2C] leading-tight mb-1">
                              {item.title} 
                              {isEditMode && <button onClick={() => handleEditField(`schedule.${idx}.items.${i}.title`, item.title, 'æ¨™é¡Œ')} className="ml-2 text-yellow-500"><LucideIcon name="pencil" className="w-3 h-3"/></button>}
                            </h3>
                            <p className="text-sm text-gray-500 mb-2">
                              {item.location}
                              {isEditMode && <button onClick={() => handleEditField(`schedule.${idx}.items.${i}.location`, item.location, 'åœ°é»')} className="ml-2 text-yellow-500"><LucideIcon name="pencil" className="w-3 h-3"/></button>}
                            </p>
                            <p className="text-sm text-gray-600 leading-relaxed">
                              {item.desc}
                              {isEditMode && <button onClick={() => handleEditField(`schedule.${idx}.items.${i}.desc`, item.desc, 'æè¿°')} className="ml-2 text-yellow-500"><LucideIcon name="pencil" className="w-3 h-3"/></button>}
                            </p>
                            {item.guide && (
                              <div className="mt-3 bg-white p-3 rounded-lg border border-gray-100 text-sm text-gray-600">
                                <p className="whitespace-pre-line">{item.guide.story?.replace(/\|/g, '\n')}</p>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                    {isEditMode && <button onClick={() => handleAddItem(idx)} className="w-full py-2 border-2 border-dashed border-gray-200 text-gray-400 rounded-xl text-sm font-bold hover:border-gray-400 hover:text-gray-500 transition-colors">+ æ–°å¢è¡Œç¨‹</button>}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* --- åˆ†é ï¼šå·¥å…· (Tools) --- */}
          {activeTab === 'tools' && (
            <div className="pt-10 px-5 animate-fade-in">
              <h2 className="text-3xl font-serif font-bold mb-6 text-[#2C2C2C]">Travel Tools</h2>
              
              {/* å¸¸ç”¨é€£çµ */}
              <div className="grid grid-cols-2 gap-4 mb-8">
                <button onClick={() => window.open('https://vjw-lp.digital.go.jp/zh-hant/', '_blank')} className="bg-[#1A1A1A] text-white p-4 rounded-2xl text-left shadow-lg">
                  <div className="mb-2"><LucideIcon name="qr-code" className="w-6 h-6"/></div>
                  <div className="font-bold">Visit Japan Web</div>
                  <div className="text-xs text-gray-400">å…¥å¢ƒå¯©æŸ¥</div>
                </button>
                <button onClick={() => window.open('https://voicetra.nict.go.jp/en/', '_blank')} className="bg-[#4F46E5] text-white p-4 rounded-2xl text-left shadow-lg">
                  <div className="mb-2"><LucideIcon name="mic" className="w-6 h-6"/></div>
                  <div className="font-bold">VoiceTra</div>
                  <div className="text-xs text-indigo-200">èªéŸ³ç¿»è­¯</div>
                </button>
              </div>

              {/* ç¥¨åˆ¸å¤¾ */}
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 mb-8 overflow-hidden">
                <div className="p-4 border-b border-gray-50 flex justify-between items-center">
                  <h3 className="font-bold text-gray-800 flex items-center"><LucideIcon name="ticket" className="w-4 h-4 mr-2 text-orange-500"/> My Tickets</h3>
                  <label className="text-xs bg-gray-100 px-2 py-1 rounded cursor-pointer hover:bg-gray-200">
                    <LucideIcon name="plus" className="w-3 h-3 inline mr-1"/>æ–°å¢
                    <input type="file" className="hidden" accept="image/*,application/pdf" onChange={handleFileUpload}/>
                  </label>
                </div>
                {tripData.tools.tickets.map((ticket, idx) => (
                  <div key={idx} onClick={() => setActiveTicket({...ticket, index: idx})} className="p-4 border-b border-gray-50 last:border-0 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                    <div className="flex items-center overflow-hidden">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0 ${ticket.type==='virtual'?'bg-purple-100 text-purple-600':'bg-orange-100 text-orange-600'}`}>
                        <LucideIcon name={ticket.type==='virtual'?'qr-code':'image'} className="w-4 h-4"/>
                      </div>
                      <div className="truncate">
                        <div className="font-bold text-sm text-gray-800 truncate">{ticket.name}</div>
                        <div className="text-xs text-gray-400">{ticket.date}</div>
                      </div>
                    </div>
                    <LucideIcon name="chevron-right" className="w-4 h-4 text-gray-300"/>
                  </div>
                ))}
                {tripData.tools.tickets.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">æš«ç„¡ç¥¨åˆ¸</div>}
              </div>

              {/* å¯¦ç”¨æ—¥èª */}
              <div className="mb-8">
                <h3 className="font-bold text-gray-800 mb-3 flex items-center"><LucideIcon name="message-circle" className="w-4 h-4 mr-2 text-blue-500"/> å¯¦ç”¨æ—¥èª</h3>
                <div className="space-y-2">
                  {JAPANESE_PHRASES.map((cat, i) => (
                    <details key={i} className="bg-white rounded-xl border border-gray-100 group">
                      <summary className="p-4 flex justify-between items-center cursor-pointer font-bold text-gray-700">
                        <div className="flex items-center"><LucideIcon name={cat.icon} className="w-4 h-4 mr-3 text-gray-400 group-open:text-blue-500"/> {cat.category}</div>
                        <LucideIcon name="chevron-down" className="w-4 h-4 text-gray-300 group-open:rotate-180 transition-transform"/>
                      </summary>
                      <div className="px-4 pb-4 space-y-2">
                        {cat.phrases.map((p, j) => (
                          <div key={j} onClick={() => setActivePhrase(p)} className="p-3 bg-gray-50 rounded-lg cursor-pointer active:scale-95 transition-transform">
                            <div className="text-lg font-bold text-gray-800">{p.jp}</div>
                            <div className="text-xs text-gray-500 flex justify-between mt-1"><span>{p.zh}</span><span className="text-blue-500 font-bold">é»æ“Šæ”¾å¤§</span></div>
                          </div>
                        ))}
                      </div>
                    </details>
                  ))}
                </div>
              </div>

              {/* ç·¨è¼¯æ¨¡å¼é–‹é—œ (å·²ä¿®å¾©ï¼) */}
              <div className="text-center mt-8 mb-8">
                <button onClick={() => setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded-full text-xs font-bold transition-colors ${isEditMode ? "bg-yellow-100 text-yellow-700" : "bg-gray-100 text-gray-400"}`}>
                  {isEditMode ? "å®Œæˆç·¨è¼¯ (Done)" : "é€²å…¥ç·¨è¼¯æ¨¡å¼ (Edit Mode)"}
                </button>
              </div>

              {/* å±éšªå€åŸŸ */}
              <div className="pb-10">
                <details>
                  <summary className="text-center text-xs text-gray-300 py-4 cursor-pointer select-none hover:text-red-400 transition-colors">(é€²éš) å±éšªå€åŸŸ</summary>
                  <div className="mx-4 p-4 bg-red-50 border border-red-100 rounded-xl text-center">
                    <p className="text-xs text-red-600 font-bold mb-2">âš ï¸ å±éšªå€åŸŸ</p>
                    <p className="text-[10px] text-red-400 mb-3">é€™å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦æ¢å¾©åŸå» è¨­å®šã€‚</p>
                    <button onClick={handleForceReset} className="bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm active:scale-95 transition-transform">ç¢ºèªé‡ç½® (Reset)</button>
                  </div>
                </details>
                <div className="text-center text-[10px] text-gray-200 mt-2 font-mono">{DATA_VERSION}</div>
              </div>
            </div>
          )}

          {/* --- Modal: ç¥¨åˆ¸æª¢è¦–å™¨ --- */}
          {activeTicket && (
            <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-fade-in" onClick={() => setActiveTicket(null)}>
              <button className="absolute top-4 right-4 p-2 bg-white/10 rounded-full text-white"><LucideIcon name="x" className="w-6 h-6"/></button>
              {activeTicket.type === 'virtual' ? (
                <div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative border-t-8 border-purple-500" onClick={e=>e.stopPropagation()}>
                  <div className="p-6 text-center border-b border-dashed border-gray-200">
                    <h3 className="text-xl font-bold text-gray-800">{activeTicket.name}</h3>
                    <p className="text-sm text-gray-500 font-sans-eng">{activeTicket.date}</p>
                  </div>
                  <div className="p-6 space-y-4">
                    <div className="flex justify-between">
                      <div><p className="text-xs text-gray-400 uppercase">Time</p><p className="text-3xl font-bold font-sans-eng">{activeTicket.details.time}</p></div>
                      <div className="text-right"><p className="text-xs text-gray-400 uppercase">Pax</p><p className="text-xl font-bold font-sans-eng">{activeTicket.details.pax}</p></div>
                    </div>
                    <div className="bg-gray-50 p-4 rounded-xl space-y-2">
                      <div><p className="text-xs text-gray-400">Pick Up</p><p className="font-bold text-sm">{activeTicket.details.from}</p></div>
                      <div className="w-full h-[1px] bg-gray-200"></div>
                      <div><p className="text-xs text-gray-400">Drop Off</p><p className="font-bold text-sm">{activeTicket.details.to}</p></div>
                    </div>
                    <div className="text-center bg-gray-100 py-3 rounded-xl">
                      <p className="text-xs text-gray-400 mb-1">Booking ID</p>
                      <p className="text-2xl font-mono font-bold tracking-widest">{activeTicket.details.id}</p>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="w-full max-w-sm h-[80vh] bg-white rounded-2xl overflow-hidden flex flex-col" onClick={e=>e.stopPropagation()}>
                  <div className="flex-1 overflow-auto bg-gray-100 flex items-center justify-center p-2">
                    {activeTicket.type.includes('pdf') ? (
                      <iframe src={activeTicket.url} className="w-full h-full" title="PDF"></iframe>
                    ) : (
                      <img src={activeTicket.url} className="max-w-full max-h-full shadow-md rounded" alt="ticket"/>
                    )}
                  </div>
                  <div className="p-4 bg-white border-t border-gray-100 flex justify-between items-center">
                    <span className="text-sm font-bold truncate flex-1">{activeTicket.name}</span>
                    <button onClick={() => handleDeleteTicket(activeTicket.index)} className="text-red-500 p-2"><LucideIcon name="trash-2" className="w-5 h-5"/></button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* --- Modal: æ—¥èªå¤§å­—å¡ --- */}
          {activePhrase && (
            <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6 animate-fade-in" onClick={() => setActivePhrase(null)}>
              <div className="w-full max-w-sm bg-white rounded-3xl p-8 text-center shadow-2xl relative" onClick={e=>e.stopPropagation()}>
                <p className="text-xs text-gray-400 font-bold tracking-widest uppercase mb-6">Show this to staff</p>
                <p className="text-4xl font-bold text-gray-900 mb-2 leading-tight">{activePhrase.jp}</p>
                <p className="text-sm text-gray-400 font-sans-eng mb-6">{activePhrase.romaji}</p>
                {activePhrase.note && <div className="bg-orange-50 text-orange-700 text-xs p-2 rounded mb-6 font-bold">{activePhrase.note}</div>}
                <button onClick={() => {
                  const u = new SpeechSynthesisUtterance(activePhrase.jp); u.lang='ja-JP'; u.rate=0.8; window.speechSynthesis.speak(u);
                }} className="w-full py-3 bg-blue-500 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center">
                  <LucideIcon name="volume-2" className="w-5 h-5 mr-2"/> æ’­æ”¾èªéŸ³
                </button>
              </div>
            </div>
          )}

          {/* åº•éƒ¨å°èˆªåˆ— */}
          <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur border-t border-gray-100 p-3 flex justify-around z-40">
            <button onClick={() => setActiveTab('schedule')} className={`p-2 transition-transform active:scale-90 ${activeTab==='schedule'?'text-[#2C2C2C]':'text-gray-300'}`}><LucideIcon name="calendar-days" className="w-6 h-6"/></button>
            <button onClick={() => setActiveTab('tools')} className={`p-2 transition-transform active:scale-90 ${activeTab==='tools'?'text-[#2C2C2C]':'text-gray-300'}`}><LucideIcon name="layout-grid" className="w-6 h-6"/></button>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
